---
title: "Reading In"
author: "Elias DeLeon"
date: "2/28/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(httr)
library(jsonlite)
library(tidyverse)
```

```{r read, include=FALSE}
mtgjson <- read_csv("raw-data/AllPrintingsCSVFiles.tar.bz2")
```

```{r functions, include=FALSE}
deckify <- function(data) {
  sample_deck <- read_delim(data, delim = "\n", col_names = FALSE) %>% 
    mutate(duplicates = str_extract(X1, "\\d{0,3}"),
           from_set = substr(str_extract(X1, "\\(.*?\\)"), 2, 4),
           gatherer_id = substr(str_extract(X1, "\\) \\d{0,6}"),
                                 2, nchar(X1)),
           card_name = substr(X1, nchar(duplicates) + 2, nchar(X1) - nchar(from_set) - nchar(gatherer_id) - 3),
           X1 = NULL)
}

find_folder <- function(x) {
  list.files(path = paste0("magic_world_championships/magic_worlds_", x),
                    pattern = "*.txt",
                    full.names = TRUE)
}

recool <- function(x) {
  x %>%   
    rev() %>% 
    paste(collapse = " ")
}
```

```{r files, include=FALSE}
files_2015 <- find_folder(2015)

files_2016 <- find_folder(2016)

files_2017 <- find_folder(2017)

files_2018 <- find_folder(2018)

files_2020 <- find_folder(2020)

files <- c(files_2015, files_2016, files_2017, files_2018, files_2020)
```

```{r decks, include=FALSE}
decks_2015 <- tibble(File = files_2015) %>%
    extract(File, "player", "-(.*)'", remove = FALSE) %>%
    mutate(Data = map(File, deckify)) %>%
    unnest(Data) %>%
    mutate(year = 2015) %>% 
    select(-File)

decks_2016 <- tibble(File = files_2016) %>%
    extract(File, "player", "-(.*)_", remove = FALSE) %>%
    mutate(Data = map(File, deckify)) %>%
    unnest(Data) %>%
    mutate(year = 2016) %>% 
    select(-File)

decks_2017 <- tibble(File = files_2017) %>%
    extract(File, "player", "([A-Z][a-z]+, [A-Z][a-z]+)", remove = FALSE) %>%
    mutate(Data = map(File, deckify)) %>%
    unnest(Data) %>%
    mutate(year = 2017, player = map(strsplit(player, ", "), recool)) %>% 
    select(-File)

decks_2018 <- tibble(File = files_2018) %>%
    extract(File, "player", "([A-Z][a-z]+, [A-Z][a-z]+)", remove = FALSE) %>%
    mutate(Data = map(File, deckify)) %>%
    unnest(Data) %>%
    mutate(year = 2018, player = map(strsplit(player, ", "), recool)) %>% 
    select(-File)

decks_2020 <- tibble(File = files_2020) %>%
    extract(File, "player", "([A-Z][a-z]+-[A-Z][a-z]+)", remove = FALSE) %>%
    mutate(Data = map(File, deckify)) %>%
    unnest(Data) %>%
    mutate(year = 2020,
           player = map(strsplit(player, "-"), paste, collapse = " ")) %>% 
    select(-File)

decks <- rbind(decks_2015, decks_2016, decks_2017, decks_2018, decks_2020) %>% 
  unnest(player)

decks <- decks %>% 
  mutate(player = recode(player, "Damo da Rosa" = "Paulo Vitor Damo da Rosa",
                                 "Paulo Rosa" = "Paulo Vitor Damo da Rosa",
                                 "Paulo Vitor" = "Paulo Vitor Damo da Rosa",
                                 "Brian Duin" = "Brian Braun-Duin",
                                 "Josh Leyton" = "Josh Utter-Leyton",
                                 "Jean Emmanuel" = "Jean Emmanuel Depraz"),
         ranking = case_when(
           (year == 2015 & player == "Seth Manfield") | 
             (year == 2016 & player == "Brian Braun-Duin") | 
             (year == 2017 & player == "William Jensen") | 
             (year == 2018 & player == "Javier Dominguez") | 
             (year == 2020 & player == "Paulo Vitor Damo da Rosa") ~ 1,
           (year == 2015 & player == "Owen Turtenwald") | 
             (year == 2016 & player == "Marcio Carvalho") | 
             (year == 2017 & player == "Javier Dominguez") | 
             (year == 2018 & player == "Grezgorz Kowalski") | 
             (year == 2020 & player == "Marcio Carvalho") ~ 2,
           (year == 2015 & player == "Paul Rietzl") | 
             (year == 2016 & player == "Oliver Tiu") | 
             (year == 2017 & player == "Josh Utter-Leyton") | 
             (year == 2018 & player == "Ben Stark") | 
             (year == 2020 & player == "Seth Manfield	") ~ 3,
           (year == 2015 & player == "Samuel Black") | 
             (year == 2016 & player == "Shota Yasooka") | 
             (year == 2017 & player == "Kelvin Chew") | 
             (year == 2018 & player == "Shahar Shenhar") | 
             (year == 2020 & player == "Gabriel Nassif") ~ 4,
           (year == 2015 & player == "Magnus Lantto") | 
             (year == 2016 & player == "Lukas Blohon") | 
             (year == 2017 & player == "Reid Duke") | 
             (year == 2018 & player == "Allen Wu") | 
             (year == 2020 & player == "Sebastian Pozzo") ~ 5,
           (year == 2015 & player == "Martin Muller") | 
             (year == 2016 & player == "Luis Scott-Vargas") | 
             (year == 2017 & player == "Samuel Black") | 
             (year == 2018 & player == "Wyatt Darby") | 
             (year == 2020 & player == "Eli Loveman") ~ 6,
           (year == 2015 & player == "Shaun McLaren") | 
             (year == 2016 & player == "Jiachen Tao") | 
             (year == 2017 & player == "Seth Manfield") | 
             (year == 2018 & player == "Matthew Nass") | 
             (year == 2020 & player == "Jean-Emmanuel Depraz") ~ 7,
           (year == 2015 & player == "Thiago Saporito") | 
             (year == 2016 & player == "Seth Manfield") | 
             (year == 2017 & player == "Owen Turtenwald") | 
             (year == 2018 & player == "Ben Hull") | 
             (year == 2020 & player == "Autumn Burchett") ~ 8,
           (year == 2015 & player == "Ondrej Strasky") | 
             (year == 2016 & player == "Thiago Saporito") | 
             (year == 2017 & player == "Gerry Thompson") | 
             (year == 2018 & player == "Reid Duke") | 
             (year == 2020 & player == "Piotr Glogowski") ~ 9,
           (year == 2015 & player == "Yuuya Watanabe") | 
             (year == 2016 & player == "Steve Rubin") | 
             (year == 2017 & player == "Shota Yasooka") | 
             (year == 2018 & player == "Mike Sigrist") | 
             (year == 2020 & player == "Chris Kvartek") ~ 10,
           (year == 2015 & player == "Paulo Vitor Damo da Rosa") | 
             (year == 2016 & player == "Mike Sigrist") | 
             (year == 2017 & player == "Christian Calcano") | 
             (year == 2018 & player == "John Rolf") | 
             (year == 2020 & player == "Raphael Levy") ~ 11,
           (year == 2015 & player == "Jacob Wilson") | 
             (year == 2016 & player == "Reid Duke") | 
             (year == 2017 & player == "Paulo Vitor Damo da Rosa") | 
             (year == 2018 & player == "Marcio Carvalho") | 
             (year == 2020 & player == "Thoralf Severin") ~ 12,
           (year == 2015 & player == "Joel Larsson") | 
             (year == 2016 & player == "Brad Nelson") | 
             (year == 2017 & player == "Eric Froehlich") | 
             (year == 2018 & player == "Brad Nelson") | 
             (year == 2020 & player == "Ondrej Strasky") ~ 13,
           (year == 2015 & player == "Alexander Hayne") | 
             (year == 2016 & player == "Joel Larsson") | 
             (year == 2017 & player == "Sebastian Pozzo") | 
             (year == 2018 & player == "Elias Watsfeldt") | 
             (year == 2020 & player == "Javier Dominguez") ~ 14,
           (year == 2015 & player == "Martin Dang") | 
             (year == 2016 & player == "Paulo Vitor Damo da Rosa") | 
             (year == 2017 & player == "Brad Nelson") | 
             (year == 2018 & player == "Brian Braun-Duin") | 
             (year == 2020 & player == "Andrea Mengucci") ~ 15,
           (year == 2015 & player == "Steve Rubin") | 
             (year == 2016 & player == "Yuuya Watanabe") | 
             (year == 2017 & player == "Martin Juza") | 
             (year == 2018 & player == "Luis Salvatto") | 
             (year == 2020 & player == "Matias Leveratto") ~ 16,
           TRUE ~ 9999999
         )
)
```

```{r view}
View(decks_2015)
View(decks_2016)
View(decks_2017)
View(decks_2018)
View(decks_2020)
View(decks)
```
