---
title: "Reading In"
author: "Elias DeLeon"
date: "2/28/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(httr)
library(jsonlite)
library(tidyverse)
```

```{r read, include=FALSE}
x <- read_csv("raw-data/AllPrintingsCSVFiles.tar.bz2")

glimpse(x)
```

```{r, include=FALSE}
deckify <- function(data) {
  sample_deck <- read_delim(data, delim = "\n", col_names = FALSE) %>% 
    mutate(duplicates = str_extract(X1, "\\d{0,3}"),
           from_set = substr(str_extract(X1, "\\(.*?\\)"), 2, 4),
           gatherer_id = substr(str_extract(X1, "\\) \\d{0,6}"),
                                 2, nchar(X1)),
           card_name = substr(X1, nchar(duplicates) + 2, nchar(X1) - nchar(from_set) - nchar(gatherer_id) - 3),
           X1 = NULL)
}
```

```{r, include=FALSE}

find_folder <- function(x) {
  list.files(path = paste0("magic_world_championships/magic_worlds_", x),
                    pattern = "*.txt",
                    full.names = TRUE)
}

files_2015 <- find_folder(2015)

files_2016 <- find_folder(2016)

files_2017 <- find_folder(2017)

files_2018 <- find_folder(2018)

files_2020 <- find_folder(2020)
```

```{r, include=FALSE}
decks_2015 <- tibble(File = files_2015) %>%
    extract(File, "Player", "(^-.*'$)", remove = FALSE) %>%
    mutate(Data = map(File, deckify)) %>%
    unnest(Data) %>%
    select(-File)

decks_2016 <- tibble(File = files_2016) %>%
    extract(File, "Player", "(^-.*_$)", remove = FALSE) %>%
    mutate(Data = map(File, deckify)) %>%
    unnest(Data) %>%
    select(-File)

decks_2017 <- tibble(File = files_2017) %>%
    extract(File, "Player", "([A-Z][a-z]+,[A-Z][a-z]+)", remove = FALSE) %>%
    mutate(Data = map(File, deckify)) %>%
    unnest(Data) %>%
    select(-File)

decks_2018 <- tibble(File = files_2018) %>%
    extract(File, "Player", "([A-Z][a-z]+,[A-Z][a-z]+)", remove = FALSE) %>%
    mutate(Data = map(File, deckify)) %>%
    unnest(Data) %>%
    select(-File)

decks_2020 <- tibble(File = files_2020) %>%
    extract(File, "Player", "([A-Z][a-z]+-[A-Z][a-z]+)", remove = FALSE) %>%
    mutate(Data = map(File, deckify)) %>%
    unnest(Data) %>%
    select(-File)
```

```{r}
decks_2015 %>% 
  head(150) %>% 
  glimpse()

decks_2016 %>% 
  head(150) %>% 
  glimpse()

decks_2017 %>% 
  head(150) %>% 
  glimpse()

decks_2018 %>% 
  head(150) %>% 
  glimpse()

decks_2020 %>% 
  head(150) %>% 
  glimpse()
```

```{r}
View(decks_2015)
View(decks_2016)
View(decks_2017)
View(decks_2018)
View(decks_2020)
```

Updates: I have been cleaning the data for years 2015-2018, finding regexes to
extract their filenames for the table, and creating the tibbles for each year,
to be joined altogether soon. I have also read in my master tibble of all
magic cards, so my data is 80% read in at this point.
